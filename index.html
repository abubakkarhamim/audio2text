<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini Audio Transcriber</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    body { 
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      font-family: "Merriweather",-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      transition: background-color 0.3s;
    }
    body.menu-open {
      overflow: hidden;
    }
    .container { 
      max-width: 400px;
      width: 100%;
      padding: 20px;
      transition: filter 0.3s;
    }
    body.menu-open .container {
      filter: blur(5px);
    }
    .recording-screen {
      background: white;
      border-radius: 20px;
      padding: 40px 20px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .controls {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin-top: 40px;
    }
    .control-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid #000;
      background: white;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .control-button:hover {
      background: #f8f9fa;
    }
    .control-button.recording {
      background: #ff4d4d;
      border-color: #ff4d4d;
    }
    .timer {
      font-size: 24px;
      font-weight: 500;
      margin: 20px 0;
    }
    .wave-animation {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 40px 0;
    }
    .wave-dot {
      width: 15px;
      height: 15px;
      background: #e0e0e0;
      border-radius: 50%;
    }
    .recording .wave-dot {
      animation: wave 1s infinite;
    }
    .wave-dot:nth-child(2) { animation-delay: 0.2s; }
    .wave-dot:nth-child(3) { animation-delay: 0.4s; }
    .wave-dot:nth-child(4) { animation-delay: 0.6s; }

    @keyframes wave {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.5); }
    }

    #transcription {
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      min-height: 100px;
    }

    .settings-menu {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
    }

    .settings-dropdown {
      position: fixed;
      top: 0;
      right: -100%;
      width: 300px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      padding: 60px 20px 20px;
      transition: right 0.3s ease-in-out;
      z-index: 1000;
    }

    .settings-dropdown.show {
      right: 0;
    }

    .settings-button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      position: relative;
      z-index: 1002;
    }
    
    .settings-button .icon-menu {
        display: block;
    }
    .settings-button .icon-close {
        display: none;
    }

    body.menu-open .settings-button .icon-menu {
        display: none;
    }
    body.menu-open .settings-button .icon-close {
        display: block;
    }


    @media (max-width: 480px) {
      .container {
        max-width: 100%;
        padding: 10px;
      }
      .recording-screen {
        padding: 20px 10px;
      }
      .control-button {
        width: 70px;
        height: 70px;
      }
      .timer {
        font-size: 28px;
      }
      .settings-menu {
        top: 10px;
        right: 10px;
      }
      .settings-dropdown {
        width: 100%;
        right: -100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="settings-menu">
      <button class="settings-button" id="settingsButton">
        <svg class="icon-menu" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
        <svg class="icon-close" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
      
      <div class="settings-dropdown" id="settingsDropdown">
        <div class="mb-3">
          <label for="apiKey" class="form-label">Gemini API Key</label>
          <div class="input-group">
            <input type="password" class="form-control" id="apiKey" placeholder="Enter your Gemini API key" required>
            <button class="btn btn-outline-secondary" type="button" id="saveApiKey">Save</button>
          </div>
        </div>
        <div class="mb-3">
          <label for="model" class="form-label">Model</label>
          <select class="form-select" id="model">
            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
            <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
            <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            <option value="gemini-pro">Gemini Pro</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="prompt" class="form-label">Prompt (optional)</label>
          <input type="text" class="form-control" id="prompt" 
                 placeholder="e.g., Transcribe the audio to text. The audio is in English.">
        </div>
      </div>
    </div>

    <div class="recording-screen">
      <h3>Recording</h3>
      
      <div class="wave-animation">
        <div class="wave-dot"></div>
        <div class="wave-dot"></div>
        <div class="wave-dot"></div>
        <div class="wave-dot"></div>
      </div>

      <div class="timer" id="timer">00:00</div>

      <div class="controls">
        <button class="control-button" id="resetButton">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2v2a8 8 0 1 1-8 8H2a10 10 0 1 0 10-10z"/>
          </svg>
        </button>
        <button class="control-button" id="recordButton">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <circle cx="12" cy="12" r="8"/>
          </svg>
        </button>
        <button class="control-button" id="finishButton">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
          </svg>
        </button>
      </div>
    </div>

    <input type="file" id="audioFile" accept="audio/*" style="display: none;">

    <div id="transcription" class="mt-4"></div>
    <button id="copyButton" class="btn btn-secondary mt-2" style="display: none;">Copy</button>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let timerInterval;
    let startTime;
    let stream;

    document.addEventListener("DOMContentLoaded", () => {
      const savedApiKey = localStorage.getItem("geminiApiKey");
      if (savedApiKey) {
        document.getElementById("apiKey").value = savedApiKey;
      }
    });

    document.getElementById("saveApiKey").addEventListener("click", () => {
      const apiKey = document.getElementById("apiKey").value;
      if (apiKey) {
        localStorage.setItem("geminiApiKey", apiKey);
        alert("API key saved locally.");
      } else {
        alert("Please enter an API key.");
      }
    });

    document.getElementById("recordButton").addEventListener("click", async () => {
      const recordButton = document.getElementById("recordButton");
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          console.log("Microphone stream started.");
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
          
          mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: "audio/webm" });
            const file = new File([blob], "recording.webm", { type: "audio/webm" });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            document.getElementById("audioFile").files = dataTransfer.files;
            audioChunks = [];
            recordButton.classList.remove("recording");
            document.querySelector('.wave-animation').classList.remove('recording');
          };

          mediaRecorder.start();
          recordButton.classList.add("recording");
          document.querySelector('.wave-animation').classList.add('recording');
          startTimer();
        } catch (err) {
          console.error("Error starting recording:", err);
          alert("Could not start recording. Please make sure you have a microphone connected and have granted permission.");
        }
      } else {
        stopRecording();
      }
    });

    document.getElementById('resetButton').addEventListener('click', () => {
      stopRecording();
      audioChunks = [];
      document.getElementById('recordButton').classList.remove("recording");
      document.querySelector('.wave-animation').classList.remove('recording');
      document.getElementById('transcription').textContent = "";
      document.getElementById('audioFile').value = "";
      document.getElementById('copyButton').style.display = 'none';
    });

    document.getElementById('finishButton').addEventListener('click', async () => {
      stopRecording();
      // Small delay to ensure the onstop event has time to process
      setTimeout(startTranscription, 100);
    });

    document.getElementById('copyButton').addEventListener('click', () => {
      const transcriptionText = document.getElementById('transcription').textContent;
      navigator.clipboard.writeText(transcriptionText).then(() => {
        const copyButton = document.getElementById('copyButton');
        copyButton.textContent = 'Copied!';
        setTimeout(() => {
          copyButton.textContent = 'Copy';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy text: ', err);
      });
    });

    async function startTranscription() {
      const transcriptionDiv = document.getElementById("transcription");
      const copyButton = document.getElementById('copyButton');
      const apiKey = document.getElementById("apiKey").value;
      const model = document.getElementById("model").value;
      const file = document.getElementById("audioFile").files[0];
      
      // First prompt just for transcription
      const transcriptionPrompt = "Transcribe the audio to text accurately, maintaining all spoken words.";
      
      if (!apiKey || !file) {
        transcriptionDiv.textContent = "Please provide an API key in settings and record audio first.";
        return;
      }

      transcriptionDiv.textContent = "Processing...";
      copyButton.style.display = 'none';

      const reader = new FileReader();
      reader.onload = async function() {
        transcriptionDiv.textContent = "Transcribing...";
        const base64Data = btoa(
          new Uint8Array(reader.result)
            .reduce((data, byte) => data + String.fromCharCode(byte), '')
        );

        try {
          // Step 1: Get raw transcription
          const transcriptionRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{
                role: "user",
                parts: [
                  { text: transcriptionPrompt },
                  {
                    inline_data: {
                      mime_type: file.type,
                      data: base64Data
                    }
                  }
                ]
              }]
            })
          });

          const transcriptionData = await transcriptionRes.json();
          
          if (transcriptionRes.status === 429) {
            transcriptionDiv.textContent = "Error: You have exceeded your API quota. Please check your plan and billing details.";
            return;
          }

          if (!transcriptionData.candidates?.[0]?.content) {
            throw new Error("Invalid transcription response");
          }

          const rawTranscription = transcriptionData.candidates[0].content.parts[0].text;
          transcriptionDiv.textContent = "Cleaning up transcription...";

          // Step 2: Clean up the transcription
          const cleanupPrompt = `Please clean up this transcription by:
1. Removing filler words like 'um', 'uh', 'hmm', etc.
2. Removing unintentional word repetitions
3. Maintaining intentional repetitions used for emphasis
4. Keeping the meaning and content intact
5. No extra information or anything just clean text.

Transcription to clean:
${rawTranscription}`;

          const cleanupRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              contents: [{
                role: "user",
                parts: [{ text: cleanupPrompt }]
              }]
            })
          });

          const cleanupData = await cleanupRes.json();
          
          if (cleanupData.candidates?.[0]?.content) {
            transcriptionDiv.textContent = cleanupData.candidates[0].content.parts[0].text;
            copyButton.style.display = 'block';
          } else {
            console.error("Error with cleanup API response:", cleanupData);
            transcriptionDiv.textContent = rawTranscription; // Fallback to raw transcription
            copyButton.style.display = 'block';
          }
        } catch (err) {
          console.error("Error during transcription:", err);
          transcriptionDiv.textContent = "Error: Could not complete the transcription process.";
        }
      };
      
      reader.readAsArrayBuffer(file);
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        console.log("Microphone stream stopped.");
      }
      stopTimer();
    }

    function updateTimer() {
      const now = new Date().getTime();
      const elapsed = now - startTime;
      const seconds = Math.floor(elapsed / 1000);
      const minutes = Math.floor(seconds / 60);
      const displaySeconds = (seconds % 60).toString().padStart(2, '0');
      const displayMinutes = minutes.toString().padStart(2, '0');
      document.getElementById('timer').textContent = `${displayMinutes}:${displaySeconds}`;
    }

    function startTimer() {
      startTime = new Date().getTime();
      timerInterval = setInterval(updateTimer, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById('timer').textContent = '00:00';
    }

    document.getElementById('settingsButton').addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('settingsDropdown').classList.toggle('show');
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.settings-menu')) {
        document.getElementById('settingsDropdown').classList.remove('show');
      }
    });
  </script>
</body>
</html>
